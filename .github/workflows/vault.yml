name: Vault Secrets Test (curl)

on:
  workflow_dispatch:

jobs:
  vault:
    runs-on: ubuntu-latest

    steps:
      - name: Debug secrets
        run: |
          echo "VAULT_ADDR=[$VAULT_ADDR]"
          echo "ROLE_ID length=${#VAULT_ROLE_ID}"
          echo "SECRET_ID length=${#VAULT_SECRET_ID}"
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_ROLE_ID: ${{ secrets.VAULT_ROLE_ID }}
          VAULT_SECRET_ID: ${{ secrets.VAULT_SECRET_ID }}

      - name: Login to Vault using AppRole (curl)
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_ROLE_ID: ${{ secrets.VAULT_ROLE_ID }}
          VAULT_SECRET_ID: ${{ secrets.VAULT_SECRET_ID }}
        run: |
          RESPONSE=$(curl -s -X POST \
            "$VAULT_ADDR/v1/auth/approle/login" \
            -H "Content-Type: application/json" \
            -d '{
              "role_id": "'"$VAULT_ROLE_ID"'",
              "secret_id": "'"$VAULT_SECRET_ID"'"
            }')

          echo "$RESPONSE"

          VAULT_TOKEN=$(echo "$RESPONSE" | jq -r '.auth.client_token')
          echo "VAULT_TOKEN=$VAULT_TOKEN" >> $GITHUB_ENV

      - name: Read secret from Vault (curl)
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
        run: |
          curl -s \
            -H "X-Vault-Token: $VAULT_TOKEN" \
            "$VAULT_ADDR/v1/secret/data/app/config" | jq
